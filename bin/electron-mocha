#!/usr/bin/env node

var path = require('path')
var spawn = require('child_process').spawn
var which = require('which')

which('electron', function (err, resolvedPath) {
  if (!resolvedPath && !process.env.ELECTRON_PATH) {
    console.error('')
    console.error('  Can not find `electron` in the $PATH and $ELECTRON_PATH is not set.')
    console.error('  Please either set $ELECTRON_PATH or run `npm i -g electron-prebuilt`.')
    console.error('')
    process.exit(1)
  }

  if (!resolvedPath) return runElectron(process.env.ELECTRON_PATH)
  if (resolvedPath) return runElectron(resolvedPath)
  if (err) console.error(err)
})

function runElectron (resolvedPath) {
  var args = process.argv.slice(2)
  args.unshift(path.resolve(path.join(__dirname, '../index.js')))
  var electron = spawn(resolvedPath, args, { stdio: [process.stdin, 'pipe', 'pipe'] })
  electron.stderr.on('data', function (data) {
    var str = data.toString('utf8')

    // If there was an uncaught exception, fail tests.
    if (str.match(/Uncaught Error:/g)) {
      process.stderr.write(data)
      electron.stderr.pause()
      return process.exit(1)
    }

    // it's Chromium, STFU
    if (str.match(/^\[\d+\:\d+/)) return
    process.stderr.write(data)
  })

  electron.stdout.on('data', function(data) {
    var str = data.toString('utf8')

    if (str.indexOf('Electron_Exit_Code:') > -1) {
      var split = str.split(': ')
      var exit_code = parseInt(split[split.length - 1])
      process.exit(exit_code)
    }

    process.stdout.write(data)
  })
}
